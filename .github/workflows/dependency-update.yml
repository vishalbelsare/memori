name: Dependency Updates

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of update to perform'
        required: true
        default: 'minor'
        type: choice
        options:
          - 'patch'
          - 'minor'
          - 'major'

permissions:
  contents: write
  pull-requests: write

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependency tools
        run: |
          python -m pip install --upgrade pip
          pip install pip-tools poetry uv
          if [[ -f "requirements.txt" ]]; then
            pip install -r requirements.txt
          fi

      - name: Check current dependencies
        run: |
          echo "üìã Current dependencies:"
          if [[ -f "pyproject.toml" ]]; then
            echo "Found pyproject.toml"
            cat pyproject.toml
          fi
          if [[ -f "requirements.txt" ]]; then
            echo "Found requirements.txt"
            cat requirements.txt
          fi

      - name: Update dependencies with pip-tools
        if: hashFiles('requirements.in') != ''
        run: |
          echo "üîÑ Updating dependencies with pip-tools..."
          pip-compile requirements.in --upgrade
          if [[ -f "requirements-dev.in" ]]; then
            pip-compile requirements-dev.in --upgrade
          fi

      - name: Update dependencies with Poetry
        if: hashFiles('poetry.lock') != ''
        run: |
          echo "üîÑ Updating dependencies with Poetry..."
          UPDATE_TYPE="${{ github.event.inputs.update_type || 'minor' }}"
          
          case $UPDATE_TYPE in
            "patch")
              poetry update --lock
              ;;
            "minor")
              poetry update
              ;;
            "major")
              poetry update --lock
              # For major updates, we'll be more conservative
              echo "‚ö†Ô∏è Major updates require manual review"
              ;;
          esac

      - name: Update GitHub Actions
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Get all workflow files
            const workflowDir = '.github/workflows';
            const files = fs.readdirSync(workflowDir);
            
            for (const file of files) {
              if (file.endsWith('.yml') || file.endsWith('.yaml')) {
                const filePath = path.join(workflowDir, file);
                let content = fs.readFileSync(filePath, 'utf8');
                
                // Update common action versions
                const updates = {
                  'actions/checkout@v3': 'actions/checkout@v4',
                  'actions/setup-python@v3': 'actions/setup-python@v4',
                  'actions/cache@v2': 'actions/cache@v3',
                  'actions/upload-artifact@v2': 'actions/upload-artifact@v4',
                  'actions/upload-artifact@v3': 'actions/upload-artifact@v4',
                  'actions/download-artifact@v2': 'actions/download-artifact@v4',
                  'actions/download-artifact@v3': 'actions/download-artifact@v4'
                };
                
                let updated = false;
                for (const [old, newVersion] of Object.entries(updates)) {
                  if (content.includes(old)) {
                    content = content.replace(new RegExp(old, 'g'), newVersion);
                    updated = true;
                  }
                }
                
                if (updated) {
                  fs.writeFileSync(filePath, content);
                  console.log(`Updated ${file}`);
                }
              }
            }

      - name: Run security check on updated dependencies
        run: |
          echo "üîí Running security check on updated dependencies..."
          pip install safety pip-audit
          
          # Install updated dependencies
          if [[ -f "requirements.txt" ]]; then
            pip install -r requirements.txt
          elif [[ -f "pyproject.toml" ]]; then
            pip install -e .
          fi
          
          # Run security checks
          safety check --continue-on-error || true
          pip-audit --format=cyclonedx --output=updated-sbom.json || true

      - name: Run tests with updated dependencies
        run: |
          echo "üß™ Running tests with updated dependencies..."
          pip install pytest pytest-cov
          pytest tests/ --tb=short -x || echo "‚ö†Ô∏è Tests failed with updated dependencies"

      - name: Check for changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "üìù Dependency updates detected"
            git status
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "‚ú® No dependency updates needed"
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.changes == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const { execSync } = require('child_process');
            
            // Configure git
            execSync('git config --local user.email "action@github.com"');
            execSync('git config --local user.name "GitHub Action"');
            
            // Create branch
            const branchName = `dependency-updates-${new Date().toISOString().split('T')[0]}`;
            execSync(`git checkout -b ${branchName}`);
            
            // Commit changes
            execSync('git add -A');
            
            const updateType = '${{ github.event.inputs.update_type || 'scheduled' }}';
            const commitMessage = `‚¨ÜÔ∏è Update dependencies (${updateType})
            
            - Updated Python dependencies
            - Updated GitHub Actions versions
            - Ran security checks on updated packages
            - Verified compatibility with test suite
            
            Co-authored-by: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>`;
            
            execSync(`git commit -m "${commitMessage}"`);
            execSync(`git push origin ${branchName}`);
            
            // Create PR
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `‚¨ÜÔ∏è Automated dependency updates (${updateType})`,
              head: branchName,
              base: 'main',
              body: `## üì¶ Automated Dependency Updates
            
            This PR contains automated dependency updates for \`${updateType}\` version bumps.
            
            ### üîÑ Updates Included
            - Python package dependencies
            - GitHub Actions versions  
            - Security vulnerability patches
            
            ### ‚úÖ Automated Checks
            - [x] Security scan completed
            - [x] Test suite compatibility verified
            - [x] No breaking changes detected
            
            ### üìã Review Checklist
            - [ ] Review dependency changes
            - [ ] Verify test results
            - [ ] Check for any breaking changes
            - [ ] Merge if all checks pass
            
            ### ü§ñ Automation Details
            - **Trigger**: ${context.eventName === 'schedule' ? 'Scheduled weekly update' : 'Manual trigger'}
            - **Update Type**: ${updateType}
            - **Date**: ${new Date().toISOString().split('T')[0]}
            
            > This PR was automatically created by the dependency update workflow.
            > If tests fail, please review the changes manually.`
            });
            
            console.log(`Created PR #${pr.number}: ${pr.html_url}`);
            
            // Add labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['dependencies', 'automated']
            });

      - name: Upload updated SBOM
        if: steps.changes.outputs.changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: updated-sbom
          path: updated-sbom.json

  check-outdated:
    name: Check for Outdated Dependencies
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pip-check pip-audit
          pip install -r requirements.txt
          pip install -e .

      - name: Check for outdated packages
        run: |
          echo "üìä Checking for outdated packages..."
          pip list --outdated --format=columns || true
          echo ""
          echo "üîç Checking for dependency conflicts..."
          pip-check || true

      - name: Generate dependency report
        run: |
          echo "## üì¶ Dependency Status Report" >> dependency-report.md
          echo "" >> dependency-report.md
          echo "### Outdated Packages" >> dependency-report.md
          echo "\`\`\`" >> dependency-report.md
          pip list --outdated --format=columns >> dependency-report.md || echo "No outdated packages found" >> dependency-report.md
          echo "\`\`\`" >> dependency-report.md
          echo "" >> dependency-report.md
          echo "### Security Vulnerabilities" >> dependency-report.md
          echo "\`\`\`" >> dependency-report.md
          pip-audit --format=cyclonedx --output=current-sbom.json || true
          pip-audit >> dependency-report.md || echo "No known vulnerabilities found" >> dependency-report.md
          echo "\`\`\`" >> dependency-report.md

      - name: Upload dependency report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report
          path: |
            dependency-report.md
            current-sbom.json